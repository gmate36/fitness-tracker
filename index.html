<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0B0B0F">
<link rel="manifest" href="./manifest.json">
<title>–¢—Ä–µ–∫–µ—Ä</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0B0B0F;
  --surface: #15151C;
  --surface2: #1E1E28;
  --accent: #FF6B2C;
  --accent-dim: rgba(255,107,44,0.15);
  --green: #2DD4A0;
  --green-dim: rgba(45,212,160,0.15);
  --red: #FF4757;
  --text: #E8E8ED;
  --text2: #9494A3;
  --text3: #5A5A6B;
  --radius: 14px;
  --radius-sm: 10px;
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}

* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
  font-family: 'Outfit', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100dvh;
  padding: calc(var(--safe-top) + 12px) 16px calc(var(--safe-bottom) + 100px) 16px;
  -webkit-font-smoothing: antialiased;
  overscroll-behavior: none;
}

/* Header */
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
}

.header-left h1 {
  font-size: 26px;
  font-weight: 800;
  letter-spacing: -0.5px;
}

.header-left .date {
  font-size: 14px;
  color: var(--text2);
  margin-top: 2px;
  font-weight: 500;
}

.settings-btn {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: var(--surface);
  border: 1px solid var(--surface2);
  color: var(--text2);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 20px;
  transition: all 0.2s;
}

.settings-btn:active { transform: scale(0.92); background: var(--surface2); }

/* Banner */
.banner {
  background: linear-gradient(135deg, rgba(255,71,87,0.15), rgba(255,107,44,0.1));
  border: 1px solid rgba(255,71,87,0.25);
  border-radius: var(--radius);
  padding: 14px 16px;
  margin-bottom: 20px;
  font-size: 14px;
  color: var(--red);
  font-weight: 500;
  display: none;
}

.banner.show { display: block; }

/* Workout Card */
.workout-card {
  background: var(--surface);
  border: 1px solid var(--surface2);
  border-radius: var(--radius);
  overflow: hidden;
  margin-bottom: 16px;
}

.workout-header {
  padding: 18px 16px;
  display: flex;
  align-items: center;
  gap: 14px;
}

.workout-icon {
  width: 44px;
  height: 44px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  flex-shrink: 0;
}

.workout-icon.gym { background: var(--accent-dim); }
.workout-icon.core { background: rgba(99,102,241,0.15); }
.workout-icon.run { background: rgba(59,130,246,0.15); }
.workout-icon.rest { background: var(--green-dim); }
.workout-icon.measure { background: rgba(168,85,247,0.15); }

.workout-info h2 {
  font-size: 17px;
  font-weight: 700;
  letter-spacing: -0.3px;
}

.workout-info .subtitle {
  font-size: 13px;
  color: var(--text2);
  margin-top: 2px;
}

.workout-status {
  margin-left: auto;
  flex-shrink: 0;
}

.check-circle {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  border: 2px solid var(--text3);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s;
  color: transparent;
  font-size: 14px;
}

.check-circle.done {
  background: var(--green);
  border-color: var(--green);
  color: #fff;
}

/* Exercise List */
.exercise-list { padding: 0 12px 12px; }

.exercise-item {
  background: var(--bg);
  border-radius: var(--radius-sm);
  margin-bottom: 8px;
  overflow: hidden;
  transition: all 0.2s;
}

.exercise-row {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 12px;
  cursor: pointer;
  user-select: none;
}

.ex-check {
  width: 24px;
  height: 24px;
  border-radius: 7px;
  border: 2px solid var(--text3);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  transition: all 0.25s;
  font-size: 12px;
  color: transparent;
}

.ex-check.done {
  background: var(--green);
  border-color: var(--green);
  color: #fff;
}

.ex-name {
  font-size: 14px;
  font-weight: 600;
  flex: 1;
}

.ex-target {
  font-size: 12px;
  color: var(--text3);
  font-weight: 500;
}

.ex-hint {
  font-size: 11px;
  color: var(--accent);
  padding: 0 12px 8px 48px;
  font-weight: 500;
  display: none;
}

.ex-hint.show { display: block; }

/* Sets Panel */
.sets-panel {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.35s ease;
  padding: 0 12px;
}

.sets-panel.open {
  max-height: 800px;
}

.set-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
}

.set-num {
  font-size: 12px;
  color: var(--text3);
  width: 14px;
  text-align: center;
  flex-shrink: 0;
}

.set-input {
  width: 70px;
  height: 38px;
  border-radius: 8px;
  border: 1px solid var(--surface2);
  background: var(--surface);
  color: var(--text);
  font-family: 'Outfit', sans-serif;
  font-size: 15px;
  font-weight: 600;
  text-align: center;
  outline: none;
  transition: border-color 0.2s;
}

.set-input:focus { border-color: var(--accent); }

.set-label {
  font-size: 11px;
  color: var(--text3);
  font-weight: 500;
}

.set-delete {
  width: 28px;
  height: 28px;
  border-radius: 7px;
  background: none;
  border: none;
  color: var(--text3);
  font-size: 16px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-left: auto;
  flex-shrink: 0;
}

.set-delete:active { color: var(--red); }

.add-set-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 10px 0;
  margin-bottom: 12px;
  background: none;
  border: none;
  color: var(--accent);
  font-family: 'Outfit', sans-serif;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
}

.add-set-btn:active { opacity: 0.7; }

/* Time input for plank exercises */
.set-input.time-input { width: 90px; }

/* Run Section */
.run-section {
  background: var(--bg);
  border-radius: var(--radius-sm);
  padding: 14px 12px;
  margin: 0 12px 12px;
}

.run-section h3 {
  font-size: 14px;
  font-weight: 700;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.run-fields {
  display: flex;
  gap: 12px;
}

.run-field {
  flex: 1;
}

.run-field label {
  font-size: 11px;
  color: var(--text3);
  font-weight: 500;
  display: block;
  margin-bottom: 6px;
}

.run-field input {
  width: 100%;
  height: 42px;
  border-radius: 8px;
  border: 1px solid var(--surface2);
  background: var(--surface);
  color: var(--text);
  font-family: 'Outfit', sans-serif;
  font-size: 16px;
  font-weight: 600;
  text-align: center;
  outline: none;
}

.run-field input:focus { border-color: var(--accent); }

/* Measurements */
.measure-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  padding: 0 12px 12px;
}

.measure-item {
  background: var(--bg);
  border-radius: var(--radius-sm);
  padding: 12px;
}

.measure-item label {
  font-size: 11px;
  color: var(--text2);
  font-weight: 500;
  display: block;
  margin-bottom: 6px;
}

.measure-item input {
  width: 100%;
  height: 42px;
  border-radius: 8px;
  border: 1px solid var(--surface2);
  background: var(--surface);
  color: var(--text);
  font-family: 'Outfit', sans-serif;
  font-size: 16px;
  font-weight: 600;
  text-align: center;
  outline: none;
}

.measure-item input:focus { border-color: var(--accent); }

.measure-item.full { grid-column: 1 / -1; }

.save-measures-btn {
  width: calc(100% - 24px);
  margin: 0 12px 12px;
  padding: 14px;
  border-radius: var(--radius-sm);
  background: var(--accent);
  color: #fff;
  border: none;
  font-family: 'Outfit', sans-serif;
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
  transition: transform 0.15s;
}

.save-measures-btn:active { transform: scale(0.97); }

/* Completed Section */
.completed-section {
  margin-top: 28px;
}

.completed-title {
  font-size: 13px;
  color: var(--text3);
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 12px;
}

.completed-section .workout-card {
  opacity: 0.6;
}

/* Analytics Page */
.page { display: none; }
.page.active { display: block; }

.back-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  background: none;
  border: none;
  color: var(--accent);
  font-family: 'Outfit', sans-serif;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  margin-bottom: 20px;
  padding: 8px 0;
}

.analytics-section {
  margin-bottom: 28px;
}

.analytics-section h3 {
  font-size: 15px;
  font-weight: 700;
  margin-bottom: 14px;
}

/* Streak */
.streak-card {
  background: linear-gradient(135deg, var(--accent-dim), rgba(255,107,44,0.05));
  border: 1px solid rgba(255,107,44,0.2);
  border-radius: var(--radius);
  padding: 20px;
  text-align: center;
  margin-bottom: 24px;
}

.streak-num {
  font-size: 48px;
  font-weight: 800;
  color: var(--accent);
  line-height: 1;
}

.streak-label {
  font-size: 14px;
  color: var(--text2);
  margin-top: 4px;
  font-weight: 500;
}

/* Calendar */
.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 4px;
  margin-bottom: 8px;
}

.cal-header {
  font-size: 11px;
  color: var(--text3);
  text-align: center;
  font-weight: 600;
  padding: 4px 0;
}

.cal-day {
  aspect-ratio: 1;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: 600;
  background: var(--surface);
}

.cal-day.empty { background: none; }
.cal-day.done { background: var(--green); color: #fff; }
.cal-day.missed { background: rgba(255,71,87,0.15); color: var(--red); }
.cal-day.today { border: 2px solid var(--accent); }
.cal-day.future { opacity: 0.3; }

/* Export/Import */
.actions-row {
  display: flex;
  gap: 10px;
  margin-top: 16px;
}

.action-btn {
  flex: 1;
  padding: 14px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--surface2);
  background: var(--surface);
  color: var(--text);
  font-family: 'Outfit', sans-serif;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  text-align: center;
}

.action-btn:active { transform: scale(0.97); }
.action-btn.primary { background: var(--accent); border-color: var(--accent); color: #fff; }

input[type="file"] { display: none; }

/* Stats */
.stat-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  border-bottom: 1px solid var(--surface2);
}

.stat-row:last-child { border-bottom: none; }

.stat-name { font-size: 14px; font-weight: 500; }
.stat-val { font-size: 14px; font-weight: 700; color: var(--accent); }

/* Notification permission */
.notif-card {
  background: var(--surface);
  border: 1px solid var(--surface2);
  border-radius: var(--radius);
  padding: 16px;
  margin-bottom: 20px;
  display: none;
}

.notif-card.show { display: block; }

.notif-card p { font-size: 13px; color: var(--text2); margin-bottom: 12px; }

.notif-btn {
  padding: 10px 20px;
  border-radius: 8px;
  background: var(--accent);
  color: #fff;
  border: none;
  font-family: 'Outfit', sans-serif;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
}

/* Scrollbar */
::-webkit-scrollbar { width: 0; }

/* Animations */
@keyframes slideIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.workout-card { animation: slideIn 0.3s ease; }

/* Day Detail Modal */
.modal-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.7);
  z-index: 100;
  align-items: flex-end;
  justify-content: center;
  backdrop-filter: blur(4px);
}

.modal-overlay.open { display: flex; }

.modal-sheet {
  background: var(--surface);
  border-radius: 20px 20px 0 0;
  width: 100%;
  max-height: 75vh;
  overflow-y: auto;
  padding: 20px 16px calc(var(--safe-bottom) + 20px);
  animation: sheetUp 0.3s ease;
}

@keyframes sheetUp {
  from { transform: translateY(100%); }
  to { transform: translateY(0); }
}

.modal-handle {
  width: 36px;
  height: 4px;
  border-radius: 2px;
  background: var(--text3);
  margin: 0 auto 16px;
}

.modal-title {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 4px;
}

.modal-subtitle {
  font-size: 13px;
  color: var(--text2);
  margin-bottom: 16px;
}

.modal-ex {
  background: var(--bg);
  border-radius: var(--radius-sm);
  padding: 12px;
  margin-bottom: 8px;
}

.modal-ex-name {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 6px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.modal-ex-sets {
  font-size: 12px;
  color: var(--text2);
}

.modal-badge {
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 4px;
  font-weight: 600;
}

.modal-badge.done { background: var(--green-dim); color: var(--green); }
.modal-badge.missed { background: rgba(255,71,87,0.15); color: var(--red); }

/* Records */
.record-card {
  background: var(--bg);
  border-radius: var(--radius-sm);
  padding: 14px;
  margin-bottom: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.record-name { font-size: 14px; font-weight: 500; }
.record-val { font-size: 16px; font-weight: 800; color: var(--accent); }
.record-date { font-size: 11px; color: var(--text3); margin-top: 2px; }

.test-notif-btn {
  padding: 10px 16px;
  border-radius: 8px;
  background: var(--surface2);
  border: 1px solid var(--text3);
  color: var(--text2);
  font-family: 'Outfit', sans-serif;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  margin-top: 8px;
}

.test-notif-btn:active { transform: scale(0.97); }

.cal-day.clickable { cursor: pointer; }
.cal-day.clickable:active { opacity: 0.7; }

/* Date Navigator */
.date-nav {
  display: flex;
  align-items: center;
  gap: 2px;
  margin-top: 4px;
  margin-left: -4px;
}

.date-nav-btn {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: none;
  border: none;
  color: var(--text2);
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.date-nav-btn:active { background: var(--surface2); }
.date-nav-btn:disabled { opacity: 0.2; }

.date-nav-label {
  font-size: 14px;
  color: var(--text2);
  font-weight: 500;
}

.today-chip {
  font-size: 11px;
  color: var(--accent);
  font-weight: 600;
  background: var(--accent-dim);
  border: none;
  border-radius: 6px;
  padding: 3px 8px;
  cursor: pointer;
  margin-left: 6px;
}

.today-chip:active { opacity: 0.7; }

.run-hint {
  font-size: 12px;
  color: var(--accent);
  font-weight: 500;
  margin-bottom: 10px;
}
</style>
</head>
<body>

<div id="main-page" class="page active">
  <div class="header">
    <div class="header-left">
      <h1 id="greeting"></h1>
      <div class="date-nav">
        <button class="date-nav-btn" onclick="navigateDate(-1)">‚Äπ</button>
        <span class="date-nav-label" id="dateStr"></span>
        <button class="date-nav-btn" id="dateNextBtn" onclick="navigateDate(1)">‚Ä∫</button>
        <button class="today-chip" id="todayBtn" onclick="goToToday()" style="display:none">–°–µ–≥–æ–¥–Ω—è</button>
      </div>
    </div>
    <button class="settings-btn" onclick="showAnalytics()">‚öô</button>
  </div>
  <div class="banner" id="banner"></div>
  <div id="notifCard" class="notif-card">
    <p>–í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è? –ù–∞–ø–æ–º–Ω—é, –µ—Å–ª–∏ –ø—Ä–æ–ø—É—Å—Ç–∏—à—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É.</p>
    <button class="notif-btn" onclick="requestNotif()">–í–∫–ª—é—á–∏—Ç—å</button>
  </div>
  <div id="workoutContainer"></div>
</div>

<div id="analytics-page" class="page">
  <button class="back-btn" onclick="showMain()">‚Üê –ù–∞–∑–∞–¥</button>
  <h1 style="font-size:24px;font-weight:800;margin-bottom:24px;">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h1>
  
  <div id="streakCard" class="streak-card">
    <div class="streak-num" id="streakNum">0</div>
    <div class="streak-label">–¥–Ω–µ–π –ø–æ–¥—Ä—è–¥</div>
  </div>

  <div class="analytics-section">
    <h3>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</h3>
    <div id="calendarMonth" style="font-size:14px;font-weight:600;color:var(--text2);margin-bottom:10px;display:flex;align-items:center;justify-content:space-between;">
      <button class="back-btn" style="margin:0;font-size:20px;" onclick="calPrev()">‚Äπ</button>
      <span id="calMonthName"></span>
      <button class="back-btn" style="margin:0;font-size:20px;" onclick="calNext()">‚Ä∫</button>
    </div>
    <div class="calendar-grid" id="calGrid"></div>
    <div style="font-size:11px;color:var(--text3);margin-top:8px;display:flex;gap:12px;flex-wrap:wrap;">
      <span>üü¢ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</span><span>üî¥ –ø—Ä–æ–ø—É—â–µ–Ω–æ</span><span>üü† —Å–µ–≥–æ–¥–Ω—è</span>
    </div>
  </div>

  <div class="analytics-section">
    <h3>–õ–∏—á–Ω—ã–µ —Ä–µ–∫–æ—Ä–¥—ã</h3>
    <div id="recordsContainer"></div>
  </div>

  <div class="analytics-section">
    <h3>–õ—É—á—à–∏–µ –∑–∞–º–µ—Ä—ã</h3>
    <div id="bestMeasuresContainer"></div>
  </div>

  <div class="analytics-section">
    <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
    <div id="statsContainer" style="background:var(--surface);border-radius:var(--radius);padding:4px 16px;"></div>
  </div>

  <div class="analytics-section">
    <h3>–î–∞–Ω–Ω—ã–µ</h3>
    <div class="actions-row">
      <button class="action-btn primary" onclick="exportData()">üì§ –≠–∫—Å–ø–æ—Ä—Ç</button>
      <button class="action-btn" onclick="document.getElementById('importFile').click()">üì• –ò–º–ø–æ—Ä—Ç</button>
      <input type="file" id="importFile" accept=".json" onchange="importData(event)">
    </div>
  </div>

  <div class="analytics-section">
    <h3>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>
    <div style="background:var(--surface);border-radius:var(--radius);padding:16px;">
      <div style="font-size:13px;color:var(--text2);margin-bottom:8px;" id="notifStatus"></div>
      <button class="test-notif-btn" onclick="testNotification()">üîî –¢–µ—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</button>
    </div>
  </div>
</div>

<!-- Day Detail Modal -->
<div class="modal-overlay" id="dayModal" onclick="closeDayModal(event)">
  <div class="modal-sheet" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div class="modal-title" id="modalTitle"></div>
    <div class="modal-subtitle" id="modalSubtitle"></div>
    <div id="modalContent"></div>
  </div>
</div>

<script>
// ========== CONFIG ==========
const CORE_EXERCISES = [
  { id:'plank', name:'–ü–ª–∞–Ω–∫–∞ —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω–∞—è', targetSets:3, targetReps:'30-60 —Å–µ–∫', unit:'time' },
  { id:'superman', name:'–°—É–ø–µ—Ä–º–µ–Ω', targetSets:3, targetReps:'12-15', unit:'weight' },
  { id:'deadbug', name:'Dead bug', targetSets:3, targetReps:'10 –Ω–∞ —Å—Ç–æ—Ä–æ–Ω—É', unit:'weight' },
  { id:'ytw', name:'Prone Y-T-W', targetSets:3, targetReps:'8 –∫–∞–∂–¥–æ–π', unit:'weight' },
  { id:'sideplank', name:'–ü–ª–∞–Ω–∫–∞ –±–æ–∫–æ–≤–∞—è', targetSets:3, targetReps:'20-40 —Å–µ–∫/—Å—Ç–æ—Ä', unit:'time' },
  { id:'snowangel', name:'Reverse snow angel', targetSets:3, targetReps:'8-10', unit:'weight' },
  { id:'hollowbody', name:'Hollow body hold', targetSets:3, targetReps:'20-40 —Å–µ–∫', unit:'time' },
];

const SCHEDULE = {
  1: {
    type:'gym', icon:'üèãÔ∏è', name:'–ó–∞–ª: –ì—Ä—É–¥—å / –ü–ª–µ—á–∏ / –¢—Ä–∏—Ü–µ–ø—Å',
    exercises:[
      { id:'incline_press', name:'–ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π –Ω–∞–∫–ª–æ–Ω (30¬∞)', targetSets:3, targetReps:'8-12', unit:'weight' },
      { id:'cable_fly', name:'–°–≤–µ–¥–µ–Ω–∏–µ –∫—Ä–æ—Å—Å–æ–≤–µ—Ä / –±–∞–±–æ—á–∫–∞', targetSets:3, targetReps:'10-12', unit:'weight' },
      { id:'seated_press', name:'–ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π —Å–∏–¥—è (–Ω–µ–π—Ç—Ä.)', targetSets:3, targetReps:'10-12', unit:'weight' },
      { id:'pushdown', name:'–†–∞–∑–≥–∏–±–∞–Ω–∏–µ –Ω–∞ –±–ª–æ–∫–µ (–∫–∞–Ω–∞—Ç)', targetSets:3, targetReps:'12-15', unit:'weight' },
    ]
  },
  2: {
    type:'core_run', icon:'üî•', name:'–ö–æ—Ä + –ë–µ–≥',
    exercises: CORE_EXERCISES,
    hasRun: true
  },
  3: {
    type:'gym', icon:'üèãÔ∏è', name:'–ó–∞–ª: –°–ø–∏–Ω–∞ / –ë–∏—Ü–µ–ø—Å',
    exercises:[
      { id:'pullups', name:'–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è / —Ç—è–≥–∞ –±–ª–æ–∫–∞', targetSets:3, targetReps:'8-12', unit:'weight' },
      { id:'db_row', name:'–¢—è–≥–∞ –≥–∞–Ω—Ç–µ–ª–∏ –≤ –Ω–∞–∫–ª–æ–Ω–µ', targetSets:3, targetReps:'10-12', unit:'weight' },
      { id:'curls', name:'–°–≥–∏–±–∞–Ω–∏—è —Å –≥–∞–Ω—Ç–µ–ª—è–º–∏', targetSets:3, targetReps:'10-12', unit:'weight' },
    ]
  },
  4: {
    type:'core', icon:'üî•', name:'–ö–æ—Ä',
    exercises: CORE_EXERCISES
  },
  5: {
    type:'gym', icon:'üèãÔ∏è', name:'–ó–∞–ª: –ù–æ–≥–∏',
    exercises:[
      { id:'leg_press', name:'–ñ–∏–º –Ω–æ–≥–∞–º–∏', targetSets:3, targetReps:'10-12', unit:'weight' },
      { id:'rdl', name:'–†—É–º—ã–Ω—Å–∫–∞—è —Ç—è–≥–∞ –≥–∞–Ω—Ç–µ–ª–∏', targetSets:3, targetReps:'10-12', unit:'weight' },
    ]
  },
  6: {
    type:'core_run', icon:'üî•', name:'–ö–æ—Ä + –ë–µ–≥',
    exercises: CORE_EXERCISES,
    hasRun: true
  },
  0: {
    type:'measure', icon:'üìè', name:'–ó–∞–º–µ—Ä—ã',
    isMeasure: true
  }
};

const MEASURE_FIELDS = [
  { id:'weight', label:'–í–µ—Å (–∫–≥)', full:true },
  { id:'belly', label:'–ñ–∏–≤–æ—Ç (—Å–º)' },
  { id:'bellyHard', label:'–ñ–∏–≤–æ—Ç –∂—ë—Å—Ç–∫–∏–π' },
  { id:'bellyIn', label:'–ñ–∏–≤–æ—Ç –≤–¥–æ—Ö' },
  { id:'chestOut', label:'–ì—Ä—É–¥—å –≤—ã–¥–æ—Ö' },
  { id:'chestIn', label:'–ì—Ä—É–¥—å –≤–¥–æ—Ö' },
  { id:'biceps', label:'–ë–∏—Ü–µ–ø—Å (—Å–º)' },
  { id:'leg', label:'–ù–æ–≥–∞ –ø—Ä–∞–≤–∞—è' },
  { id:'ass', label:'–ó–∞–¥–Ω–∏—Ü–∞ (—Å–º)' },
];

const DAY_NAMES = ['–í—Å','–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±'];
const MONTH_NAMES = ['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];

// ========== STATE ==========
let data = { workouts:{}, measurements:{} };
let calMonth, calYear;
let openExercise = null;
let selectedDate = new Date();

// ========== STORAGE ==========
function loadData() {
  try {
    const raw = localStorage.getItem('fitness_data');
    if (raw) data = JSON.parse(raw);
    if (!data.workouts) data.workouts = {};
    if (!data.measurements) data.measurements = {};
  } catch(e) { data = { workouts:{}, measurements:{} }; }
}

function saveData() {
  localStorage.setItem('fitness_data', JSON.stringify(data));
}

function exportData() {
  const blob = new Blob([JSON.stringify(data, null, 2)], { type:'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `fitness-backup-${todayStr()}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

function importData(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    try {
      const imported = JSON.parse(ev.target.result);
      if (imported.workouts) {
        data = imported;
        saveData();
        render();
        alert('–î–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!');
      }
    } catch(err) { alert('–û—à–∏–±–∫–∞ —Ñ–∞–π–ª–∞'); }
  };
  reader.readAsText(file);
  e.target.value = '';
}

// ========== UTILS ==========
function todayStr() {
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

function dateStr(d) {
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

function timeStr() {
  const d = new Date();
  return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
}

function getSchedule(date) {
  const dow = date.getDay();
  return SCHEDULE[dow];
}

function getLastWorkout(exerciseId, beforeDate) {
  const keys = Object.keys(data.workouts).sort().reverse();
  const cutoff = beforeDate || todayStr();
  for (const key of keys) {
    if (key >= cutoff) continue;
    const w = data.workouts[key];
    if (w.exercises && w.exercises[exerciseId] && w.exercises[exerciseId].sets && w.exercises[exerciseId].sets.length > 0) {
      return w.exercises[exerciseId].sets;
    }
  }
  return null;
}

function formatLastSets(sets) {
  if (!sets || sets.length === 0) return null;
  const parts = sets.map(s => {
    if (s.seconds) return `${s.seconds}—Å`;
    if (s.weight > 0) return `${s.weight}–∫–≥√ó${s.reps}`;
    return `${s.reps} –ø–æ–≤—Ç`;
  });
  return '–ü—Ä–æ—à–ª—ã–π —Ä–∞–∑: ' + parts.join(', ');
}

function formatDoneSets(sets) {
  if (!sets || sets.length === 0) return '';
  return sets.map(s => {
    if (s.seconds) return `${s.seconds}—Å`;
    if (s.weight > 0) return `${s.weight}–∫–≥√ó${s.reps}`;
    if (s.reps > 0) return `${s.reps} –ø–æ–≤—Ç`;
    return '';
  }).filter(Boolean).join(', ');
}

function getLastRun(beforeDate) {
  const keys = Object.keys(data.workouts).sort().reverse();
  for (const key of keys) {
    if (key >= beforeDate) continue;
    const w = data.workouts[key];
    if (w.run && w.run.distance > 0) {
      return w.run;
    }
  }
  return null;
}

function getStreak() {
  let streak = 0;
  const d = new Date();
  const start = data._startDate || todayStr();
  const todayData = data.workouts[todayStr()];
  if (todayData && todayData.completed) {
    streak = 1;
    d.setDate(d.getDate() - 1);
  } else {
    d.setDate(d.getDate() - 1);
  }
  while (true) {
    const ds = dateStr(d);
    if (ds < start) break;
    const w = data.workouts[ds];
    if (w && w.completed) {
      streak++;
      d.setDate(d.getDate() - 1);
    } else {
      break;
    }
  }
  return streak;
}

// ========== RENDER ==========
function render() {
  const viewDate = new Date(selectedDate);
  const dow = viewDate.getDay();
  const schedule = getSchedule(viewDate);
  const dStr = dateStr(viewDate);
  const tStr = todayStr();
  const isToday = dStr === tStr;

  // Header
  document.getElementById('greeting').textContent = schedule.name;
  const dateLabel = `${DAY_NAMES[dow]}, ${viewDate.getDate()} ${MONTH_NAMES[viewDate.getMonth()].toLowerCase()}`;
  document.getElementById('dateStr').textContent = isToday ? dateLabel + ' ¬∑ —Å–µ–≥–æ–¥–Ω—è' : dateLabel;
  document.getElementById('todayBtn').style.display = isToday ? 'none' : 'inline-block';
  document.getElementById('dateNextBtn').disabled = isToday;

  // Banner - check yesterday (only when viewing today)
  const banner = document.getElementById('banner');
  if (isToday) {
    const yesterday = new Date(viewDate);
    yesterday.setDate(yesterday.getDate() - 1);
    const yStr = dateStr(yesterday);
    const yData = data.workouts[yStr];
    const ySchedule = getSchedule(yesterday);
    const startDate = data._startDate || tStr;
    if (yStr >= startDate && ySchedule && !ySchedule.isMeasure && (!yData || !yData.completed)) {
      banner.textContent = `‚ö† –í—á–µ—Ä–∞ –ø—Ä–æ–ø—É—â–µ–Ω–æ: ${ySchedule.name}`;
      banner.classList.add('show');
    } else {
      banner.classList.remove('show');
    }
  } else {
    banner.classList.remove('show');
  }

  // Notification card (only when viewing today)
  const notifCard = document.getElementById('notifCard');
  if (isToday && 'Notification' in window && Notification.permission === 'default') {
    notifCard.classList.add('show');
  } else {
    notifCard.classList.remove('show');
  }

  // Workout
  const container = document.getElementById('workoutContainer');
  const workoutData = data.workouts[dStr] || { exercises:{}, completed:false };

  if (schedule.isMeasure) {
    container.innerHTML = renderMeasurePage(dStr);
  } else {
    container.innerHTML = renderWorkoutCard(schedule, workoutData, dStr);
  }
}

function renderWorkoutCard(schedule, workoutData, dateKey) {
  const pendingExercises = schedule.exercises.filter(ex => !workoutData.exercises[ex.id]?.done);
  const doneExercises = schedule.exercises.filter(ex => workoutData.exercises[ex.id]?.done);
  const runFilled = schedule.hasRun && workoutData.run?.distance > 0 && workoutData.run?.done !== false;
  const allExDone = doneExercises.length === schedule.exercises.length;
  const runDone = schedule.hasRun ? runFilled : true;
  const isCompleted = allExDone && runDone;

  if (isCompleted && !workoutData.completed) {
    workoutData.completed = true;
    workoutData.completedAt = new Date().toISOString();
    data.workouts[dateKey] = workoutData;
    saveData();
  } else if (!isCompleted && workoutData.completed) {
    workoutData.completed = false;
    workoutData.completedAt = null;
    data.workouts[dateKey] = workoutData;
    saveData();
  }

  const iconClass = schedule.type.includes('gym') ? 'gym' : 'core';
  let html = `<div class="workout-card">
    <div class="workout-header">
      <div class="workout-icon ${iconClass}">${schedule.icon}</div>
      <div class="workout-info">
        <h2>${schedule.name}</h2>
        <div class="subtitle">${schedule.exercises.length} —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π${schedule.hasRun?' + –±–µ–≥':''} ¬∑ –æ—Ç–¥—ã—Ö 30—Å</div>
      </div>
      <div class="workout-status">
        <div class="check-circle ${isCompleted?'done':''}">‚úì</div>
      </div>
    </div>`;

  // Pending exercises
  if (pendingExercises.length > 0) {
    html += `<div class="exercise-list">`;
    for (const ex of pendingExercises) {
      const exData = workoutData.exercises[ex.id] || { done:false, sets:[] };
      const lastSets = getLastWorkout(ex.id, dateKey);
      const hint = formatLastSets(lastSets);
      const isOpen = openExercise === ex.id;

      html += `<div class="exercise-item">
        <div class="exercise-row" onclick="toggleExpand('${ex.id}','${dateKey}')">
          <div class="ex-check" onclick="event.stopPropagation();toggleDone('${ex.id}','${dateKey}')">‚úì</div>
          <div class="ex-name">${ex.name}</div>
          <div class="ex-target">${ex.targetSets}√ó${ex.targetReps}</div>
        </div>
        ${hint ? `<div class="ex-hint show">${hint}</div>` : ''}
        <div class="sets-panel ${isOpen?'open':''}">
          ${renderSets(ex, exData, dateKey)}
        </div>
      </div>`;
    }
    html += `</div>`;
  }

  // Run section (in main card when not done)
  if (schedule.hasRun && !runFilled) {
    const runData = workoutData.run || {};
    const lastRun = getLastRun(dateKey);
    html += `<div class="run-section">
      <h3>üèÉ –ë–µ–≥</h3>
      ${lastRun ? `<div class="run-hint">–ü—Ä–æ—à–ª—ã–π —Ä–∞–∑: ${lastRun.distance} –∫–º${lastRun.pace ? ' ¬∑ —Ç–µ–º–ø ' + lastRun.pace : ''}</div>` : ''}
      <div class="run-fields">
        <div class="run-field">
          <label>–î–∏—Å—Ç–∞–Ω—Ü–∏—è (–∫–º)</label>
          <input type="number" inputmode="decimal" step="0.1" value="${runData.distance||''}"
            onchange="saveRun('${dateKey}','distance',this.value)" placeholder="2.0">
        </div>
        <div class="run-field">
          <label>–¢–µ–º–ø (–º–∏–Ω/–∫–º)</label>
          <input type="text" inputmode="text" value="${runData.pace||''}"
            onchange="saveRun('${dateKey}','pace',this.value)" placeholder="5:00">
        </div>
      </div>
    </div>`;
  }

  html += `</div>`;

  // Completed section
  if (doneExercises.length > 0 || runFilled) {
    html += `<div class="completed-section">
      <div class="completed-title">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
      <div class="workout-card"><div class="exercise-list">`;

    for (const ex of doneExercises) {
      const exData = workoutData.exercises[ex.id];
      const setsStr = formatDoneSets(exData.sets);

      html += `<div class="exercise-item">
        <div class="exercise-row" onclick="toggleDone('${ex.id}','${dateKey}')">
          <div class="ex-check done">‚úì</div>
          <div class="ex-name">${ex.name}</div>
        </div>
        ${setsStr ? `<div class="ex-hint show" style="color:var(--text3);">${setsStr}</div>` : ''}
      </div>`;
    }

    if (runFilled) {
      const run = workoutData.run;
      html += `<div class="exercise-item">
        <div class="exercise-row" onclick="toggleRunDone('${dateKey}')">
          <div class="ex-check done">‚úì</div>
          <div class="ex-name">üèÉ –ë–µ–≥</div>
          <div class="ex-target">${run.distance} –∫–º${run.pace ? ' ¬∑ ' + run.pace : ''}</div>
        </div>
      </div>`;
    }

    html += `</div></div></div>`;
  }

  return html;
}

function renderSets(exercise, exData, dateKey) {
  const sets = exData.sets || [];
  const isTime = exercise.unit === 'time';
  let html = '';

  sets.forEach((s, i) => {
    if (isTime) {
      html += `<div class="set-row">
        <span class="set-num">${i+1}</span>
        <input class="set-input time-input" type="number" inputmode="numeric" value="${s.seconds||''}" 
          placeholder="—Å–µ–∫" onchange="updateSet('${exercise.id}','${dateKey}',${i},'seconds',this.value)">
        <span class="set-label">—Å–µ–∫</span>
        <button class="set-delete" onclick="deleteSet('${exercise.id}','${dateKey}',${i})">‚úï</button>
      </div>`;
    } else {
      html += `<div class="set-row">
        <span class="set-num">${i+1}</span>
        <input class="set-input" type="number" inputmode="decimal" value="${s.weight||''}" 
          placeholder="–∫–≥" onchange="updateSet('${exercise.id}','${dateKey}',${i},'weight',this.value)">
        <span class="set-label">–∫–≥</span>
        <input class="set-input" type="number" inputmode="numeric" value="${s.reps||''}" 
          placeholder="–ø–æ–≤—Ç" onchange="updateSet('${exercise.id}','${dateKey}',${i},'reps',this.value)">
        <span class="set-label">–ø–æ–≤—Ç</span>
        <button class="set-delete" onclick="deleteSet('${exercise.id}','${dateKey}',${i})">‚úï</button>
      </div>`;
    }
  });

  html += `<button class="add-set-btn" onclick="addSet('${exercise.id}','${dateKey}','${exercise.unit}')">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ö–æ–¥</button>`;
  return html;
}

function renderMeasurePage(dateKey) {
  const mData = data.measurements[dateKey] || {};
  const saved = Object.keys(mData).length > 0;

  let html = `<div class="workout-card">
    <div class="workout-header">
      <div class="workout-icon measure">üìè</div>
      <div class="workout-info">
        <h2>–ó–∞–º–µ—Ä—ã</h2>
        <div class="subtitle">–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–µ –∏–∑–º–µ—Ä–µ–Ω–∏—è</div>
      </div>
      <div class="workout-status">
        <div class="check-circle ${saved?'done':''}">‚úì</div>
      </div>
    </div>
    <div class="measure-grid">`;

  for (const f of MEASURE_FIELDS) {
    html += `<div class="measure-item ${f.full?'full':''}">
      <label>${f.label}</label>
      <input type="number" inputmode="decimal" step="0.1" value="${mData[f.id]||''}" 
        data-field="${f.id}" placeholder="‚Äî">
    </div>`;
  }

  html += `</div>
    <button class="save-measures-btn" onclick="saveMeasures('${dateKey}')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–º–µ—Ä—ã</button>
  </div>`;

  // Show last measurements for comparison
  const lastM = getLastMeasurements(dateKey);
  if (lastM) {
    html += `<div style="padding:12px 16px;font-size:12px;color:var(--text3);">
      <b>–ü—Ä–æ—à–ª—ã–µ –∑–∞–º–µ—Ä—ã (${lastM.date}):</b><br>`;
    for (const f of MEASURE_FIELDS) {
      if (lastM.data[f.id]) html += `${f.label}: ${lastM.data[f.id]} ¬∑ `;
    }
    html += `</div>`;
  }

  return html;
}

function getLastMeasurements(excludeDate) {
  const keys = Object.keys(data.measurements).filter(k => k !== excludeDate).sort().reverse();
  if (keys.length === 0) return null;
  return { date: keys[0], data: data.measurements[keys[0]] };
}

// ========== ACTIONS ==========
function toggleExpand(exId, dateKey) {
  openExercise = openExercise === exId ? null : exId;
  render();
}

function toggleDone(exId, dateKey) {
  if (!data.workouts[dateKey]) data.workouts[dateKey] = { exercises:{}, completed:false };
  if (!data.workouts[dateKey].exercises[exId]) data.workouts[dateKey].exercises[exId] = { done:false, sets:[] };
  
  const ex = data.workouts[dateKey].exercises[exId];
  ex.done = !ex.done;
  ex.doneAt = ex.done ? timeStr() : null;
  saveData();
  render();
}

function addSet(exId, dateKey, unit) {
  if (!data.workouts[dateKey]) data.workouts[dateKey] = { exercises:{}, completed:false };
  if (!data.workouts[dateKey].exercises[exId]) data.workouts[dateKey].exercises[exId] = { done:false, sets:[] };
  
  const sets = data.workouts[dateKey].exercises[exId].sets;
  if (unit === 'time') {
    sets.push({ seconds:'' });
  } else {
    // Pre-fill from last set or last workout
    const lastSet = sets.length > 0 ? sets[sets.length-1] : null;
    if (lastSet) {
      sets.push({ weight: lastSet.weight, reps: lastSet.reps });
    } else {
      const prev = getLastWorkout(exId, dateKey);
      if (prev && prev.length > 0) {
        sets.push({ weight: prev[0].weight, reps: prev[0].reps });
      } else {
        sets.push({ weight:'', reps:'' });
      }
    }
  }
  saveData();
  render();
}

function updateSet(exId, dateKey, idx, field, value) {
  const v = value === '' ? '' : parseFloat(value);
  data.workouts[dateKey].exercises[exId].sets[idx][field] = v;
  saveData();
}

function deleteSet(exId, dateKey, idx) {
  data.workouts[dateKey].exercises[exId].sets.splice(idx, 1);
  saveData();
  render();
}

function saveRun(dateKey, field, value) {
  if (!data.workouts[dateKey]) data.workouts[dateKey] = { exercises:{}, completed:false };
  if (!data.workouts[dateKey].run) data.workouts[dateKey].run = {};
  data.workouts[dateKey].run[field] = field === 'distance' ? parseFloat(value) || 0 : value;
  // Auto-mark run as done when distance is entered
  if (data.workouts[dateKey].run.distance > 0) {
    data.workouts[dateKey].run.done = true;
  } else {
    data.workouts[dateKey].run.done = false;
  }
  saveData();
  render();
}

function toggleRunDone(dateKey) {
  if (!data.workouts[dateKey] || !data.workouts[dateKey].run) return;
  data.workouts[dateKey].run.done = !data.workouts[dateKey].run.done;
  saveData();
  render();
}

function saveMeasures(dateKey) {
  const inputs = document.querySelectorAll('.measure-item input');
  const mData = {};
  let hasData = false;
  inputs.forEach(inp => {
    const val = parseFloat(inp.value);
    if (!isNaN(val) && val > 0) {
      mData[inp.dataset.field] = val;
      hasData = true;
    }
  });
  if (hasData) {
    data.measurements[dateKey] = mData;
    // Also mark as completed workout
    data.workouts[dateKey] = { completed:true, completedAt:new Date().toISOString(), exercises:{}, isMeasure:true };
    saveData();
    render();
  }
}

// ========== DATE NAVIGATION ==========
function navigateDate(offset) {
  selectedDate.setDate(selectedDate.getDate() + offset);
  const today = new Date();
  today.setHours(0,0,0,0);
  const sel = new Date(selectedDate);
  sel.setHours(0,0,0,0);
  if (sel > today) selectedDate = new Date();
  openExercise = null;
  render();
}

function goToToday() {
  selectedDate = new Date();
  openExercise = null;
  render();
}

// ========== ANALYTICS ==========
function showAnalytics() {
  document.getElementById('main-page').classList.remove('active');
  document.getElementById('analytics-page').classList.add('active');
  
  const now = new Date();
  calMonth = now.getMonth();
  calYear = now.getFullYear();
  
  renderAnalytics();
}

function showMain() {
  document.getElementById('analytics-page').classList.remove('active');
  document.getElementById('main-page').classList.add('active');
}

function renderAnalytics() {
  // Streak
  document.getElementById('streakNum').textContent = getStreak();
  
  // Calendar
  renderCalendar();
  
  // Stats
  renderStats();
  
  // Records
  renderRecords();
  
  // Best measures
  renderBestMeasures();
  
  // Notification status
  const status = document.getElementById('notifStatus');
  if ('Notification' in window) {
    const perm = Notification.permission;
    status.textContent = perm === 'granted' ? '‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã' : 
                          perm === 'denied' ? '‚ùå –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã' : 
                          '‚è≥ –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–µ –∑–∞–ø—Ä–æ—à–µ–Ω–æ';
  } else {
    status.textContent = '‚ùå –ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è';
  }
}

function renderCalendar() {
  document.getElementById('calMonthName').textContent = `${MONTH_NAMES[calMonth]} ${calYear}`;
  
  const grid = document.getElementById('calGrid');
  let html = '';
  
  // Headers
  ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'].forEach(d => {
    html += `<div class="cal-header">${d}</div>`;
  });
  
  const firstDay = new Date(calYear, calMonth, 1);
  let startDow = firstDay.getDay() - 1;
  if (startDow < 0) startDow = 6;
  
  const daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();
  const today = new Date();
  const todayS = todayStr();
  
  // Empty cells
  for (let i = 0; i < startDow; i++) {
    html += `<div class="cal-day empty"></div>`;
  }
  
  for (let d = 1; d <= daysInMonth; d++) {
    const ds = `${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const dt = new Date(calYear, calMonth, d);
    const isToday = ds === todayS;
    const isFuture = dt > today;
    const w = data.workouts[ds];
    const start = data._startDate || todayS;
    
    let cls = 'cal-day';
    if (isToday) cls += ' today';
    if (isFuture) cls += ' future';
    else if (w && w.completed) cls += ' done clickable';
    else if (!isFuture && ds !== todayS && ds >= start) cls += ' missed';
    
    if (w && w.completed) {
      html += `<div class="${cls}" onclick="openDayModal('${ds}')">${d}</div>`;
    } else {
      html += `<div class="${cls}">${d}</div>`;
    }
  }
  
  grid.innerHTML = html;
}

function calPrev() {
  calMonth--;
  if (calMonth < 0) { calMonth = 11; calYear--; }
  renderCalendar();
}

function calNext() {
  calMonth++;
  if (calMonth > 11) { calMonth = 0; calYear++; }
  renderCalendar();
}

function renderStats() {
  const container = document.getElementById('statsContainer');
  const totalDays = Object.values(data.workouts).filter(w => w.completed).length;
  const gymDays = Object.entries(data.workouts).filter(([k,w]) => {
    const d = new Date(k);
    const s = SCHEDULE[d.getDay()];
    return w.completed && s && s.type === 'gym';
  }).length;
  const coreDays = Object.entries(data.workouts).filter(([k,w]) => {
    const d = new Date(k);
    const s = SCHEDULE[d.getDay()];
    return w.completed && s && (s.type === 'core' || s.type === 'core_run');
  }).length;
  const runEntries = Object.values(data.workouts).filter(w => w.run && w.run.distance > 0);
  const totalKm = runEntries.reduce((sum, w) => sum + (w.run.distance || 0), 0);
  
  container.innerHTML = `
    <div class="stat-row"><span class="stat-name">–í—Å–µ–≥–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</span><span class="stat-val">${totalDays}</span></div>
    <div class="stat-row"><span class="stat-name">–ó–∞–ª</span><span class="stat-val">${gymDays}</span></div>
    <div class="stat-row"><span class="stat-name">–ö–æ—Ä</span><span class="stat-val">${coreDays}</span></div>
    <div class="stat-row"><span class="stat-name">–ü—Ä–æ–±–µ–∂–µ–∫</span><span class="stat-val">${runEntries.length}</span></div>
    <div class="stat-row"><span class="stat-name">–û–±—â–∏–π –ø—Ä–æ–±–µ–≥</span><span class="stat-val">${totalKm.toFixed(1)} –∫–º</span></div>
    <div class="stat-row"><span class="stat-name">–ó–∞–º–µ—Ä–æ–≤</span><span class="stat-val">${Object.keys(data.measurements).length}</span></div>
  `;
}

// ========== PERSONAL RECORDS ==========
function renderRecords() {
  const container = document.getElementById('recordsContainer');
  const records = {};
  
  // Go through all workouts and find best sets per exercise
  for (const [dateKey, w] of Object.entries(data.workouts)) {
    if (!w.exercises) continue;
    for (const [exId, exData] of Object.entries(w.exercises)) {
      if (!exData.sets) continue;
      for (const s of exData.sets) {
        if (s.weight > 0 && s.reps > 0) {
          const key = exId;
          if (!records[key] || s.weight > records[key].weight || 
              (s.weight === records[key].weight && s.reps > records[key].reps)) {
            records[key] = { weight: s.weight, reps: s.reps, date: dateKey };
          }
        }
        if (s.seconds > 0) {
          const key = exId + '_time';
          if (!records[key] || s.seconds > records[key].seconds) {
            records[key] = { seconds: s.seconds, date: dateKey };
          }
        }
      }
    }
  }
  
  // Get exercise names from schedule
  const allExercises = {};
  for (const s of Object.values(SCHEDULE)) {
    if (s.exercises) s.exercises.forEach(e => allExercises[e.id] = e.name);
  }
  
  if (Object.keys(records).length === 0) {
    container.innerHTML = '<div style="font-size:13px;color:var(--text3);padding:12px;">–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –ù–∞—á–Ω–∏ –∑–∞–ø–æ–ª–Ω—è—Ç—å –ø–æ–¥—Ö–æ–¥—ã!</div>';
    return;
  }
  
  let html = '<div style="background:var(--surface);border-radius:var(--radius);padding:8px;">';
  for (const [key, rec] of Object.entries(records)) {
    const exId = key.replace('_time', '');
    const name = allExercises[exId] || exId;
    const val = rec.seconds ? `${rec.seconds} —Å–µ–∫` : `${rec.weight} –∫–≥ √ó ${rec.reps}`;
    html += `<div class="record-card">
      <div>
        <div class="record-name">${name}</div>
        <div class="record-date">${rec.date}</div>
      </div>
      <div class="record-val">${val}</div>
    </div>`;
  }
  html += '</div>';
  container.innerHTML = html;
}

function renderBestMeasures() {
  const container = document.getElementById('bestMeasuresContainer');
  const allMeasures = Object.entries(data.measurements);
  
  if (allMeasures.length === 0) {
    container.innerHTML = '<div style="font-size:13px;color:var(--text3);padding:12px;">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–º–µ—Ä–æ–≤</div>';
    return;
  }
  
  // For weight and belly - best is lowest. For chest, biceps - best is highest
  const bestConfig = {
    weight: { label: '–í–µ—Å (–∫–≥)', best: 'min' },
    belly: { label: '–ñ–∏–≤–æ—Ç', best: 'min' },
    bellyHard: { label: '–ñ–∏–≤–æ—Ç –∂—ë—Å—Ç–∫–∏–π', best: 'min' },
    bellyIn: { label: '–ñ–∏–≤–æ—Ç –≤–¥–æ—Ö', best: 'min' },
    chestOut: { label: '–ì—Ä—É–¥—å –≤—ã–¥–æ—Ö', best: 'max' },
    chestIn: { label: '–ì—Ä—É–¥—å –≤–¥–æ—Ö', best: 'max' },
    biceps: { label: '–ë–∏—Ü–µ–ø—Å', best: 'max' },
    leg: { label: '–ù–æ–≥–∞ –ø—Ä–∞–≤–∞—è', best: 'max' },
    ass: { label: '–ó–∞–¥–Ω–∏—Ü–∞', best: 'max' },
  };
  
  let html = '<div style="background:var(--surface);border-radius:var(--radius);padding:8px;">';
  
  for (const [field, config] of Object.entries(bestConfig)) {
    let bestVal = null;
    let bestDate = null;
    
    for (const [dateKey, m] of allMeasures) {
      if (m[field] !== undefined && m[field] > 0) {
        if (bestVal === null || 
            (config.best === 'min' && m[field] < bestVal) ||
            (config.best === 'max' && m[field] > bestVal)) {
          bestVal = m[field];
          bestDate = dateKey;
        }
      }
    }
    
    if (bestVal !== null) {
      html += `<div class="record-card">
        <div>
          <div class="record-name">${config.label}</div>
          <div class="record-date">${bestDate}</div>
        </div>
        <div class="record-val">${bestVal}</div>
      </div>`;
    }
  }
  
  html += '</div>';
  container.innerHTML = html;
}

// ========== DAY DETAIL MODAL ==========
function openDayModal(ds) {
  const modal = document.getElementById('dayModal');
  const w = data.workouts[ds];
  if (!w) return;
  
  const dt = new Date(ds + 'T12:00:00');
  const schedule = getSchedule(dt);
  
  document.getElementById('modalTitle').textContent = schedule ? schedule.name : '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞';
  document.getElementById('modalSubtitle').textContent = `${DAY_NAMES[dt.getDay()]}, ${dt.getDate()} ${MONTH_NAMES[dt.getMonth()].toLowerCase()} ${dt.getFullYear()}`;
  
  let html = '';
  
  // Measurements
  if (w.isMeasure && data.measurements[ds]) {
    const m = data.measurements[ds];
    for (const f of MEASURE_FIELDS) {
      if (m[f.id]) {
        html += `<div class="modal-ex">
          <div class="modal-ex-name">${f.label}: <span style="color:var(--accent);font-weight:800;">${m[f.id]}</span></div>
        </div>`;
      }
    }
  }
  
  // Exercises
  if (w.exercises && schedule && schedule.exercises) {
    for (const ex of schedule.exercises) {
      const exData = w.exercises[ex.id];
      const isDone = exData && exData.done;
      
      html += `<div class="modal-ex">
        <div class="modal-ex-name">
          ${ex.name}
          <span class="modal-badge ${isDone?'done':'missed'}">${isDone?'‚úì':'‚Äî'}</span>
        </div>`;
      
      if (exData && exData.sets && exData.sets.length > 0) {
        const setsStr = exData.sets.map((s, i) => {
          if (s.seconds) return `${i+1}) ${s.seconds} —Å–µ–∫`;
          if (s.weight > 0) return `${i+1}) ${s.weight} –∫–≥ √ó ${s.reps}`;
          if (s.reps > 0) return `${i+1}) ${s.reps} –ø–æ–≤—Ç`;
          return '';
        }).filter(Boolean).join(' &nbsp;¬∑&nbsp; ');
        html += `<div class="modal-ex-sets">${setsStr}</div>`;
      }
      
      if (exData && exData.doneAt) {
        html += `<div style="font-size:11px;color:var(--text3);margin-top:4px;">–≤ ${exData.doneAt}</div>`;
      }
      
      html += `</div>`;
    }
  }
  
  // Run
  if (w.run && w.run.distance > 0) {
    html += `<div class="modal-ex">
      <div class="modal-ex-name">üèÉ –ë–µ–≥</div>
      <div class="modal-ex-sets">${w.run.distance} –∫–º${w.run.pace ? ' ¬∑ —Ç–µ–º–ø ' + w.run.pace : ''}</div>
    </div>`;
  }
  
  if (w.completedAt) {
    html += `<div style="font-size:12px;color:var(--green);margin-top:12px;text-align:center;">‚úì –ó–∞–≤–µ—Ä—à–µ–Ω–æ</div>`;
  }
  
  document.getElementById('modalContent').innerHTML = html;
  modal.classList.add('open');
}

function closeDayModal(e) {
  if (e.target === document.getElementById('dayModal')) {
    document.getElementById('dayModal').classList.remove('open');
  }
}

// ========== TEST NOTIFICATION ==========
function testNotification() {
  if ('Notification' in window) {
    if (Notification.permission === 'granted') {
      new Notification('–¢–µ—Å—Ç! üí™', { body: '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç. –ù–µ –∑–∞–±—É–¥—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É!' });
    } else if (Notification.permission === 'default') {
      Notification.requestPermission().then(perm => {
        if (perm === 'granted') {
          new Notification('–¢–µ—Å—Ç! üí™', { body: '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã –∏ —Ä–∞–±–æ—Ç–∞—é—Ç!' });
        }
        renderAnalytics();
      });
    } else {
      alert('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã. –†–∞–∑—Ä–µ—à–∏ –∏—Ö –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Safari –¥–ª—è —ç—Ç–æ–≥–æ —Å–∞–π—Ç–∞.');
    }
  } else {
    alert('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è');
  }
}
async function requestNotif() {
  if ('Notification' in window) {
    const perm = await Notification.requestPermission();
    if (perm === 'granted') {
      new Notification('–¢—Ä–µ–∫–µ—Ä', { body: '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã! üí™' });
    }
    render();
  }
}

function checkAndNotify() {
  if ('Notification' in window && Notification.permission === 'granted') {
    const tStr2 = todayStr();
    const w = data.workouts[tStr2];
    if (!w || !w.completed) {
      const schedule = getSchedule(new Date());
      if (schedule && !schedule.isMeasure) {
        // Only notify after 19:00
        if (new Date().getHours() >= 19) {
          new Notification('–ù–µ –∑–∞–±—É–¥—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É!', { 
            body: schedule.name,
            icon: 'üèãÔ∏è'
          });
        }
      }
    }
  }
}

// ========== SERVICE WORKER ==========
if ('serviceWorker' in navigator) {
  let refreshing = false;
  navigator.serviceWorker.addEventListener('controllerchange', () => {
    if (!refreshing) { refreshing = true; location.reload(); }
  });
  navigator.serviceWorker.register('./sw.js').catch(() => {});
}

// ========== INIT ==========
loadData();
if (!data._startDate) {
  data._startDate = todayStr();
  saveData();
}
render();

// Check notifications every 30 min if page is open
setInterval(checkAndNotify, 30 * 60 * 1000);

// Re-render at midnight
setInterval(() => {
  const now = new Date();
  if (now.getHours() === 0 && now.getMinutes() === 0) { selectedDate = new Date(); render(); }
}, 60000);
</script>
</body>
</html>
